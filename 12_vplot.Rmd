---
title: "TSS profiles protein-coding transcripts"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


```{r, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide")
source("config")
source("config.R")
source("common.R")
```
```{r}
# score_filenames = paste0("/home/chuffarf/projects/datashare/", gse, "/", samples, "_end-to-end_trim30_bowtie2_", species, "_", annotation, "_", version, "_srt.bam")
# bam_file = score_filenames[4]
#   bamfile <- "/home/chuffarf/projects/datashare/atacseq_govin_2023spoatacseq1/veg1_end-to-end_trim30_bowtie2_Saccharomyces_cerevisiae_UCSC_sacCer3_srt.bam"

library(GenomicRanges)
library(VplotR)

for (sample in samples[4]) {
  bamfile = paste0("/home/chuffarf/projects/datashare/", gse, "/", sample, "_end-to-end_trim30_bowtie2_", species, "_", annotation, "_", version, "_srt.bam")
  fragments = importPEBamFiles(
      bamfile, 
      shift_ATAC_fragments = TRUE
  )
  # fragments

  genes_file = paste0("~/projects/datashare/genomes/", species, "/", annotation, "/", version, "/Annotation/Genes/genes.bed")
  genes = read.table(genes_file, header=FALSE)
  head(genes)

  # split and convert per region
  genes = GRanges(
      seqnames = genes$V1,
      ranges = IRanges(start = ifelse(genes$V6=="+", genes$V2, genes$V3),
                      end =   ifelse(genes$V6=="+", genes$V2, genes$V3) + 1,
                      names = genes$V4),
      strand = genes$V6
    )

  df <- getFragmentsDistribution(
      fragments, 
      genes
  )
  #> Warning in as.cls(x): NAs introduced by coercion
  #> Warning in as.cls(x): NAs introduced by coercion
  #> Warning in as.cls(x): NAs introduced by coercion
  p <- ggplot(df, aes(x = x, y = y)) + geom_line() + theme_ggplot2() +
       labs(title = sample)
  plot(p)
  #> Warning: 
  p <- plotVmat(x = fragments, granges = genes) +
       labs(title = sample)
  plot(p)
}
```


# Session Information

```{r results="verbatim"}
sessionInfo()
date()
```



























