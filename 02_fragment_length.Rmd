---
title: "Fragment sizes"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---


```{r, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide")
``` 

```{r eval=FALSE}
samtools view -bq 30 S_pp2_end-to-end_trim30_srt.bam > S_pp2_end-to-end_trim30_srt_mmq30.bam &
samtools view -bq 30 S_pp4_end-to-end_trim30_srt.bam > S_pp4_end-to-end_trim30_srt_mmq30.bam &
samtools view -bq 30 S_pp6_end-to-end_trim30_srt.bam > S_pp6_end-to-end_trim30_srt_mmq30.bam &
samtools view -bq 30 S_nn2_end-to-end_trim30_srt.bam > S_nn2_end-to-end_trim30_srt_mmq30.bam &
samtools view -bq 30 S_nn4_end-to-end_trim30_srt.bam > S_nn4_end-to-end_trim30_srt_mmq30.bam &
samtools view -bq 30 S_nn6_end-to-end_trim30_srt.bam > S_nn6_end-to-end_trim30_srt_mmq30.bam &

samtools index S_pp2_end-to-end_trim30_srt_mmq30.bam &
samtools index S_pp4_end-to-end_trim30_srt_mmq30.bam &
samtools index S_pp6_end-to-end_trim30_srt_mmq30.bam &
samtools index S_nn2_end-to-end_trim30_srt_mmq30.bam &
samtools index S_nn4_end-to-end_trim30_srt_mmq30.bam &
samtools index S_nn6_end-to-end_trim30_srt_mmq30.bam &

rsync -auvP dahu:~/projects/small_structs/results/hist_frag_size/ ~/projects/small_structs/results/hist_frag_size/

```

```{r label="bamPEFragmentSize", eval=TRUE}
get_nb_reads = function(bam_file) {
  cmd = "samtools"
  args = paste0("view -c ", bam_file)
  print(paste(cmd, args))
  nb_reads = as.numeric(system2(cmd, args, stdout=TRUE))
  return(nb_reads)
}

bam_files = c(
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp2_end-to-end_trim30_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp4_end-to-end_trim30_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp6_end-to-end_trim30_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn2_end-to-end_trim30_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn4_end-to-end_trim30_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn6_end-to-end_trim30_srt_mmq30.bam"
)




# if (!exists("mscanBam")) {
#   mscanBam = function(f) {
#     library("Rsamtools")
#     mscanBam = memoise::memoise(scanBam)
#     memoise::memoise(Rsamtools::scanBam(f))
#   }
# }
#
# if (! exists("mscanBam")) {
#   library("Rsamtools")
#   mscanBam = memoise::memoise(scanBam)
# }
#
# bam_file = "~/projects/datashare_epistorage/TGML_runs/bam_epimed/F_ast_end-to-end_trim30.bam"
# bam = Rsamtools::scanBam(bam_file)
# bam = mscanBam(bam_file)



# rsync -auvP epidata:~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp2_end-to-end_trim30_srt_mmq30.bam ~/projects/datashare_epistorage/TGML_runs/bam_epimed/.
# rsync -auvP epidata:~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn2_end-to-end_trim30_srt_mmq30.bam ~/projects/datashare_epistorage/TGML_runs/bam_epimed/.
#
bam_wt = Rsamtools::scanBam("~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp2_end-to-end_trim30_srt_mmq30.bam")
bam_ko = Rsamtools::scanBam("~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn2_end-to-end_trim30_srt_mmq30.bam")
# bam2 = mscanBam(bam_file)
# names(bam[[1]])
# length(bam[[1]]$qname)
# b = bam[[1]]

dir.create("hist_frag_size", showWarnings=FALSE)
options =   paste0("--numberOfProcessors 32 --maxFragmentLength 500 --binSize 10000 --distanceBetweenBins 1000000")
nb_reads = lapply(bam_files, function(bam_file) {
  prefix = rev(strsplit(bam_file, "/|\\.")[[1]])[2]
  print(prefix)
  cmd = "bamPEFragmentSize"
  args = paste0("-b ", bam_file, " -o hist_frag_size/", prefix, ".png --outRawFragmentLengths hist_frag_size/", prefix, ".txt ", options)
  print(paste(cmd, args))
  if (substr(Sys.info()["nodename"], 1, 4) %in% c("luke", "dahu", "epid")) {
    system2(cmd, args)
  }
  if (substr(Sys.info()["nodename"], 1, 4) %in% c("luke", "dahu", "epid")) {
    nb_reads = get_nb_reads(bam_file)
  } else {
    nb_reads = NA
  }
  ret = c()
  ret[prefix] = nb_reads
  return(ret)
})
nb_reads = unlist(nb_reads)
nb_reads

bam_files_filtered = c(
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp2_end-to-end_trim30_fsmin025_fsmax075_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp4_end-to-end_trim30_fsmin025_fsmax075_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp6_end-to-end_trim30_fsmin025_fsmax075_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn2_end-to-end_trim30_fsmin025_fsmax075_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn4_end-to-end_trim30_fsmin025_fsmax075_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn6_end-to-end_trim30_fsmin025_fsmax075_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp2_end-to-end_trim30_fsmin125_fsmax175_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp4_end-to-end_trim30_fsmin125_fsmax175_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_pp6_end-to-end_trim30_fsmin125_fsmax175_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn2_end-to-end_trim30_fsmin125_fsmax175_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn4_end-to-end_trim30_fsmin125_fsmax175_srt_mmq30.bam",
  "~/projects/datashare_epistorage/TGML_runs/bam_epimed/S_nn6_end-to-end_trim30_fsmin125_fsmax175_srt_mmq30.bam"
)

nb_reads_filtered = lapply(bam_files_filtered, function(bam_file) {
  prefix = rev(strsplit(bam_file, "/|\\.")[[1]])[2]
  print(prefix)
  if (substr(Sys.info()["nodename"], 1, 4) %in% c("luke", "dahu", "epid")) {
    nb_reads = get_nb_reads(bam_file)
  } else {
    nb_reads = NA
  }
  ret = c()
  ret[prefix] = nb_reads
  return(ret)
})
nb_reads_filtered = unlist(nb_reads_filtered)
nb_reads_filtered


foo = c(nb_reads, nb_reads_filtered)

samples = unique(do.call(rbind,strsplit(names(foo), "_end-to-end_trim30_|\\.bam"))[,])
samples
rows = unique(samples[,1])
cols = unique(samples[,2])
rows 
cols 

df = data.frame(row.names=rows)
for (col in cols) {
  df[[col]] = NA  
}
df

for (nb in names(foo)) {
  sample = strsplit(nb, "_end-to-end_trim30_|\\.bam")
  sample
  row = sample[[1]][1]
  col = sample[[1]][2]
  row
  col 
  df[row,col] = foo[[nb]]    
}

colnames(df) = c("total", "ss", "nuc")
df
df$ss_p = df$ss / df$total
df$nuc_p = df$nuc / df$total
df$ss_nuc_p = df$ss_p + df$nuc_p 
df

saveRDS(df, "df.rds")
```


```{r echo=FALSE, out.width="100%", results="asis"}
for (bam_file in bam_files) {
  prefix = rev(strsplit(bam_file, "/|\\.")[[1]])[2]
  cat(paste0("![](", "hist_frag_size/", prefix, ".png", ")"), "\n")
}
```





```{r label="hists", eval=TRUE}
# hist_file = "hist_end-to-end_trim30_srt.txt"
# h = read.table(hist_file, stringsAsFactors=FALSE, header=TRUE)
# h$stage =  substr(h[,3], 67, 71)
# h = read.table("hist_S_pp6_end-to-end_trim30_srt.txt", stringsAsFactors=FALSE, header=TRUE)
layout(matrix(1:2, 1), respect=TRUE)
plot(0, 0, col=0, ylab="", xlab="", ylim=c(0,0.05), xlim=c(1,250), main="H2AL2 WT")
# stages = c("S_pp2",  "S_pp4",  "S_pp6",  "S_nn2",  "S_nn4",  "S_nn6" )
stages = c("S_pp2",  "S_pp4",  "S_pp6")
for (stage in stages) {
  h = read.table(paste0("hist_", stage, "_end-to-end_trim30_srt.txt"), stringsAsFactors=FALSE, header=TRUE)
  idx = h[,1] < 250 #& h$stage == stage
  baz = stats::ksmooth(h[idx,1], h[idx,2]/sum(h[idx,2]), "normal", bandwidth = 5)
  lines(baz, col=which(stages %in% stage))
}

abline(v=c(25, 75, 125, 175), lty=2)
legend("topright", paste0("disgestion ", as.numeric(substr(stages, 5,5))*2, "min"), col=1:length(stages), lty=1)

plot(0, 0, col=0, ylab="", xlab="", ylim=c(0,0.05), xlim=c(1,250), main="H2AL2 KO")
stages = c("S_nn2",  "S_nn4",  "S_nn6" )
for (stage in stages) {
  h = read.table(paste0("hist_", stage, "_end-to-end_trim30_srt.txt"), stringsAsFactors=FALSE, header=TRUE)
  idx = h[,1] < 250 #& h$stage == stage
  baz = stats::ksmooth(h[idx,1], h[idx,2]/sum(h[idx,2]), "normal", bandwidth = 5)
  lines(baz, col=which(stages %in% stage))
}
abline(v=c(25, 75, 125, 175), lty=2)
legend("topright", paste0("disgestion ", as.numeric(substr(stages, 5,5))*2, "min"), col=1:length(stages), lty=1)
```




# Material and Methods

Fragment size distribution were optain using `bamPEFragmentSize` with options `r options`.




```{r results="verbatim"}
sessionInfo()
```



























